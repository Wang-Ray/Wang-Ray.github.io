---
layout: post
title: "实践kafka"
date: 2017-11-15 09:58:13 +0800
categories: 云计算
tags: cloud kafka zookeeper
---

[Kafka](http://kafka.apache.org/) is a distributed streaming platform.

Kafka是一个分布式流式处理平台。

[Confluent](https://www.confluent.io/) Apache Kafka & Streaming Platform for the Enterprise.

Confluence是Kafka三位作者离开LinkedIn后创办了Confluence.io后商业化Kafka的产品。

## 基本概念和术语

### 消息

采用ByteBuffer存储

Key：消息键，对消息做 partition 时使用，即决定消息被保存在某 topic 下的哪个 partition 。

Value：

Timestamp：

### topic

### partition

一个topic可以设置多个partition，可以实现负载

### offset

topic partition下的每一条消息都有一个offset，用于记录消息的位置。

消费者端也又一个offset，用于记录消费者消费的位置。

### leader和follower

partition leader electioin

### ISR

in-sync replica

### 生产者

精确一次（Exactly-once-semantics）

### 分区器（partitioner）



### 消费者



#### 消费者组

1个partition只能被同组的一个consumer消费，同组的consumer则起到均衡效果，即同组的不同consumer可以分别消费不同的partition。

## 概要设计

### 吞吐量和延时

* 操作系统页缓存是在内存中分配的（page cache，默认flush时间间隔是5秒），所以消息写入的速度非常快。
* Kafka不必直接与底层的文件系统打交道。所有烦琐的 1/0 操作都交由操作系统来处理 。
* Kafka写入操作采用追加写入( append )的方式，避免了磁盘随机写操作。
* 使用以 sendfile 为代表的零拷贝技术加强网络间的数据传输效率。

### 持久化

### 负载均衡和故障转移



### 伸缩性

状态保存于zookeeper

## 快速开始

启动kafka自带的zookeeper

```shell
$ bin/zookeeper-server-start.sh config/zookeeper.properties
```

启动kafka

```shell
$ bin/kafka-server-start.sh config/server.properties
```

帮助信息

```properties
# help
$ kafka-server-start.sh 
USAGE: /app/software/kafka/bin/kafka-server-start.sh [-daemon] server.properties [--override property=value]*
```

使用独立的zookeeper，需要修改kafka配置文件`config/server.properties`中`zookeeper.connect`

```properties
# zookeeper.connect=localhost:2181
zookeeper.connect=192.168.1.23:2181
```

在bin目录下新建kafka deamon启动脚本`start-kafka.sh`

```shell
#!/bin/bash
BIN_HOME=$(cd `dirname $0`;pwd)
kafka-server-start.sh -daemon "$BIN_HOME/../config/server.properties"
```

创建topic

```shell
$ bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test
```

查看topic

```shell
$ bin/kafka-topics.sh --list --zookeeper localhost:2181
test
```

发送消息

```shell
$ bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test
# 回车发送消息
This is a message
This is another message
```

消费消息

```shell
$ bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning
This is a message
This is another message
```

## 集群

### 伪集群

在一台服务器上部署3个节点，实现伪集群

config/server-1.properties:

```properties
# 各节点broker.id不能相同
broker.id=1
listeners=PLAINTEXT://:9093
log.dir=/tmp/kafka-logs-1
```

config/server-2.properties:

```properties
broker.id=2
listeners=PLAINTEXT://:9094
log.dir=/tmp/kafka-logs-2
```

config/server-2.properties:

```properties
broker.id=3
listeners=PLAINTEXT://:9095
log.dir=/tmp/kafka-logs-3
```

### 真实集群

在三台服务器（192.168.7.100、192.168.7.101和192.168.7.102）上分别部署一个节点，实现真实集群

config/server.properties

```properties
# 各节点broker.id不能相同
broker.id=1
# 各主机IP
host.name=192.168.7.100
# 设置zookeeper的连接端口，可以指定zookeeper的chroot，起到更好的隔离作用
zookeeper.connect=192.168.7.100:2181,192.168.7.101:2181,192.168.7.102:2181/kafka_cluster1
```

## Kafka Connect

## Kafka Streams

## 工具

### Kafka Manager

[Kafka Manager](https://github.com/yahoo/kafka-manager)

### Kafka Web Console

[Kafka Web Console](https://github.com/claudemamo/kafka-web-console)已停止维护，推荐使用KafkaManager

### KafkaOffsetMonitor

[KafkaOffsetMonitor](https://github.com/quantifind/KafkaOffsetMonitor)

## 参考

《Kafka技术内幕》，kafka 0.10.0.0

《Kafka入门与实践》，kafka 0.10.1.1

《Apache Kafka 实战》，kafka 1.0.0

《Kafka权威指南》，kafka 0.9.0.1

《Apache Kafka源码剖析》，kafka 0.10.0

https://blog.csdn.net/yanhanwen123/article/details/81664434

https://blog.csdn.net/lzufeng/article/details/81906031