---
layout: post
title: "实践Maven"
date: 2017-08-03 16:03:13 +0800
categories: 工具
tags: maven tool build
---

## 介绍

[Maven](https://maven.apache.org/)是一个构建工具，类似ant/gradle

## 安装

*详情可以参考[官方安装说明](https://maven.apache.org/install.html)*

### 二进制发行包

到官方下载二进制发行包，解压缩，设定环境变量即可。

### 通过包管理器

*nix系统可以使用SDKMAN，Mac可以使用Homebrew，Windows可以使用Scoop

```shell
$ sdk install gradle 4.0
```

```shell
$ gradle -v

------------------------------------------------------------
Gradle 4.0
------------------------------------------------------------

Build time:   2017-06-14 15:11:08 UTC
Revision:     316546a5fcb4e2dfe1d6aa0b73a4e09e8cecb5a5

Groovy:       2.4.11
Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015
JVM:          1.8.0_101 (Oracle Corporation 25.101-b13)
OS:           Linux 4.9.0-deepin6-amd64 amd64
```

## Lifecycle

maven包含三套生命周期：default、clean和site。

[Introduction to the lifecycle](http://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html)

### Clean Lifecycle

| `pre-clean`  | execute processes needed prior to the actual project cleaning |
| ------------ | ------------------------------------------------------------ |
| `clean`      | remove all files generated by the previous build             |
| `post-clean` | execute processes needed to finalize the project cleaning    |

### Default Lifecycle

| `validate`                | validate the project is correct and all necessary information is available. |
| ------------------------- | ------------------------------------------------------------ |
| `initialize`              | initialize build state, e.g. set properties or create directories. |
| `generate-sources`        | generate any source code for inclusion in compilation.       |
| `process-sources`         | process the source code, for example to filter any values.   |
| `generate-resources`      | generate resources for inclusion in the package.             |
| `process-resources`       | copy and process the resources into the destination directory, ready for packaging. |
| `compile`                 | compile the source code of the project.                      |
| `process-classes`         | post-process the generated files from compilation, for example to do bytecode enhancement on Java classes. |
| `generate-test-sources`   | generate any test source code for inclusion in compilation.  |
| `process-test-sources`    | process the test source code, for example to filter any values. |
| `generate-test-resources` | create resources for testing.                                |
| `process-test-resources`  | copy and process the resources into the test destination directory. |
| `test-compile`            | compile the test source code into the test destination directory |
| `process-test-classes`    | post-process the generated files from test compilation, for example to do bytecode enhancement on Java classes. For Maven 2.0.5 and above. |
| `test`                    | run tests using a suitable unit testing framework. These tests should not require the code be packaged or deployed. |
| `prepare-package`         | perform any operations necessary to prepare a package before the actual packaging. This often results in an unpacked, processed version of the package. (Maven 2.1 and above) |
| `package`                 | take the compiled code and package it in its distributable format, such as a JAR. |
| `pre-integration-test`    | perform actions required before integration tests are executed. This may involve things such as setting up the required environment. |
| `integration-test`        | process and deploy the package if necessary into an environment where integration tests can be run. |
| `post-integration-test`   | perform actions required after integration tests have been executed. This may including cleaning up the environment. |
| `verify`                  | run any checks to verify the package is valid and meets quality criteria. |
| `install`                 | install the package into the local repository, for use as a dependency in other projects locally. |
| `deploy`                  | done in an integration or release environment, copies the final package to the remote repository for sharing with other developers and projects. |

### Site Lifecycle

| `pre-site`    | execute processes needed prior to the actual project site generation |
| ------------- | ------------------------------------------------------------ |
| `site`        | generate the project's site documentation                    |
| `post-site`   | execute processes needed to finalize the site generation, and to prepare for site deployment |
| `site-deploy` | deploy the generated site documentation to the specified web server |

## pom.xml

```
jar {
    baseName = 'sample-gradle'
    version =  '0.1.0'
}
```

### 插件（Plugins）

插件是实际执行任务或目标（goals）的集合，可以**直接使用**。也可以绑定到生命周期中（添加到pom.xml的build-》plugins下），由生命周期流程驱动执行。Maven生命周期中某些phrase已经预先绑定了一些插件。

插件一般都有一个help的目标，用来显示插件的**基本信息**和包含的**goals**等。

```shell
$ mvn org.springframework.boot:spring-boot-maven-plugin:help
```

可以查看更详细的信息，比如**参数**等，以及**指定goal**

```shell
$ mvn org.springframework.boot:spring-boot-maven-plugin:help -Ddetail=true -Dgoal=run
```

更详细信息可以使用下面常用插件中介绍的**maven-help-plugin**

插件前缀（plugin-prefix）：简化插件的标示，如果插件的artifactId命名符合规范：{plugin-prefix}-maven-plugin或maven-{plugin-prefix}-plugin可会自动识别插件前缀，也可以通过*goalPrefix*自定义插件前缀。

插件解析时，默认groupId取值为org.apache.maven.plugins和org.codehaus.mojo，可以通过settings.xml中新增其他groupId，否则会报找不到指定插件前缀的插件。

```xml
<settings>
  	<pluginGroups>
		<pluginGroup>org.springframework.boot</pluginGroup>
	</pluginGroups>
</settings>
```

```shell
$ mvn spring-boot:help
```

### 依赖

```
dependencies {
    compile "joda-time:joda-time:2.2"
}
```



### 仓库

[The Central Repository Search Engine](https://search.maven.org/)

maven本地仓库默认路径：${home}/.m2/

安装构建到本地仓库，例如：

```shell
$ mvn install:install-file -DgroupId=com.oracle -DartifactId=ojdbc14 -Dversion=10.2.0.2.0 -Dpackage=jar -Dfile=d:\ojdbc14.jar
```

### 模块

父模块

```xml
<groupId>*</groupId>
<artifactId>project1</artifactId>
<version>1.0.0-SNAPSHOT</version>
<packaging>pom</packaging>
<modules>
	<module>module1</module>
	<module>module2</module>
</modules>
```

子模块

module1

```xml
<artifactId>module1</artifactId>
<packaging>jar</packaging>
<parent>
	<groupId>*</groupId>
	<artifactId>project1</artifactId>
	<version>1.0.0-SNAPSHOT</version>
</parent>

<dependency>
	<groupId>*</groupId>
	<artifactId>module2</artifactId>
	<version>1.0.0-SNAPSHOT</version>
</dependency>
```

### 继承

#### 超级POM

%mavan_home%/lib/maven-model-builder-3.0.4.jar/org/apache/maven/model/pom-4.0.0.xml

[中央仓库地址](http://repo.maven.apache.org/maven2)

## Maven Wrapper

Maven Wrapper的作用是将maven的版本纳入项目管理中，实现maven的版本由项目控制，与运行环境无关。首次运行时自动下载相应版本的maven到当前环境，升级也会非常容易。不会使用当前环境已安装的maven。

### 安装

有如下两种方法，区别主要再生成的目录，一个是.mvn，另一个是maven。

#### 方法一

参考：[maven-wrapper](https://github.com/takari/maven-wrapper),[takari-maven-plugin](https://github.com/takari/takari-maven-plugin)

```shell
# 通过wrapper目标初始化maven wrapper
$ mvn -N io.takari:maven:wrapper
```

默认使用最新稳定版本作为maven wrapper的maven版本，也可以通过如下配置定制，比如指定maven版本

```shell
$ mvn -N io.takari:maven:wrapper -Dmaven=3.3.9
# -DdistributionUrl: 指定maven下载路径
```

```shell
# 生成如下maven wrapper相关文件，将这些文件添加到版本管理。
└── sample-gradle
    └── mvnw
    └── mvnw.bat
    └── .mvn
        └── wrapper
            └── maven-wrapper.jar
            └── maven-wrapper.properties
```

maven-wrapper.properties中可以指定maven下载路径（可以使用相对目录），比如：

```properties
distributionUrl=https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.5.0/apache-maven-3.5.0-bin.zip
```

#### 方法二

参考：[maven-wrapper](https://github.com/rimerosolutions/maven-wrapper/)

添加plugin

```xml
<plugin>
	<groupId>com.rimerosolutions.maven.plugins</groupId>
	<artifactId>wrapper-maven-plugin</artifactId>
	<version>0.0.5</version>
</plugin>
```

```shell
# 通过wrapper目标初始化maven wrapper
$ mvn -N wrapper:wrapper
```

默认使用当前环境的maven版本，也可以通过如下配置定制，比如指定maven版本

```shell
$ mvn -N wrapper:wrapper -DmavenVersion=3.5.0
# -DbaseDistributionUrl: 指定maven下载路径
```

```shell
# 生成如下maven wrapper相关文件，将这些文件添加到版本管理。
└── sample-gradle
    └── mvnw
    └── mvnw.bat
    └── maven
        └── wrapper
            └── maven-wrapper.jar
            └── maven-wrapper.properties
```

maven-wrapper.properties中可以指定maven下载路径（可以使用相对目录），比如：

```properties
distributionUrl=https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.5.0/apache-maven-3.5.0-bin.zip
```

### 使用

```shell
# 使用mvnw命令代替原始的mvn
$ ./mvnv -v
```
首次会自动下载相应版本的maven，存放在~/.m2/wrapper/dists
### 升级
指定新版本的maven，重新安装即可【生成的相关文件可能会变化】

## properties

### <properties/>

```xml
<properties>
	<it.skip>false</it.skip>
</properties>
```

可以通过java系统属性提供更高优先级的设定，比如：-Dit.skip=true

### plugin属性

plugin一般都定义有属性，可以通过describe插件查看，例如：

```shell
$ mvn help:describe -Dplugin=compiler -Dgoal=compile -Ddetail
[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] Building hello-client 0.0.1-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO] 
[INFO] --- maven-help-plugin:2.2:describe (default-cli) @ cts-hello-client ---
[INFO] Mojo: 'compiler:compile'
compiler:compile
  Description: Compiles application sources
  Implementation: org.apache.maven.plugin.compiler.CompilerMojo
  Language: java
  Bound to phase: compile

  Available parameters:
...
    compilerVersion
      User property: maven.compiler.compilerVersion
      Version of the compiler to use, ex. '1.3', '1.5', if fork is set to true.

    debug (Default: true)
      User property: maven.compiler.debug
      Set to true to include debugging information in the compiled class files.

    encoding (Default: ${project.build.sourceEncoding})
      User property: encoding
      The -encoding argument for the Java compiler.

    outputFileName
      Sets the name of the output file when compiling a set of sources to a
      single file.
      expression='${project.build.finalName}'

    source (Default: 1.5)
      User property: maven.compiler.source
      The -source argument for the Java compiler.

    target (Default: 1.5)
      User property: maven.compiler.target
      The -target argument for the Java compiler.
...

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1.083 s
[INFO] Finished at: 2017-11-30T18:09:28+08:00
[INFO] Final Memory: 15M/303M
[INFO] ------------------------------------------------------------------------
```

* 可以在使用插件的地方设置属性（`<configuration>`），例如：

```xml
		   <plugin>
                <groupId>org.mybatis.generator</groupId>
                <artifactId>mybatis-generator-maven-plugin</artifactId>
                <version>1.3.2</version>
                <configuration><configurationFile>${basedir}/src/main/resources/generator/generatorConfig.xml</configurationFile>
                    <overwrite>true</overwrite>
                    <verbose>true</verbose>
                </configuration>
            </plugin>
```

* 可以在pom的`<properties>`中定义属性（只有User property属性支持），例如：

```xml
<properties>
	<maven.compiler.source>1.8</maven.compiler.source>
	<maven.compiler.target>1.8</maven.compiler.target>
  	<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
</properties>
```

* 可以通过java系统属性来设置（只有User property属性支持），例如：

```shell
$ mvn clean compile -Dmaven.test.skip=true
```



## 常用插件

###  maven-help-plugin

比插件自带的help显示更多信息，包括**插件前缀**，**goal绑定生命周期**，**参数的User property**等。

```shell
# 显示系统属性和环境变量
$ mvn help:system
# 显示spring-boot插件信息
$ mvn help:describe -Dplugin=spring-boot
# -Ddetail: 显示参数
$ mvn help:describe -Dplugin=spring-boot -Ddetail -Dgoal=run
```

### maven-surefire-plugin

-Dmaven.test.skip=true：跳过测试阶段

### maven-failsafe-plugin

[maven-failsafe-plugin](https://maven.apache.org/surefire/maven-failsafe-plugin/)集成测试

### maven-dependency-plugin

#### copy-dependencies

导出项目的依赖包

```shell
$ mvn dependency:copy-dependencies -DincludeScope=runtime
```

| 参数                         | 描述                         |
| -------------------------- | -------------------------- |
| -Dmdep.useRepositoryLayout | 按坐标目录结构，默认值：false          |
| -DoutputDirectory          | 导出目录，默认值：target/dependency |
| -DincludeScope             | 导出指定级别的依赖                  |

includeScope (Default: )

      Scope to include. An Empty string indicates all scopes (default). The
      scopes being interpreted are the scopes as Maven sees them, not as
      specified in the pom. In summary:
      - runtime scope gives runtime and compile dependencies,
      - compile scope gives compile, provided, and system dependencies,
      - test (default) scope gives all dependencies,
      - provided scope just gives provided dependencies,
      - system scope just gives system dependencies.
      User property: includeScope
#### list

```shell
$ mvn dependency:list -DincludeScope=runtime
```

## QA

### 使用sun私有代码

使用sun私有代码，编译时可能会类似错误`package com.sun.image.codec.jpeg does not exist`，解决方法如下：

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <configuration>
        <compilerArguments>
          	<!-- Linux下分隔符是: -->
            <bootclasspath>${java.home}/lib/rt.jar;${java.home}/lib/jce.jar</bootclasspath>
        </compilerArguments>
    </configuration>
</plugin>
```

或者

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-compiler-plugin</artifactId>
    <configuration>
        <compilerArguments>
            <compilerArgument>-XDignore.symbol.file</compilerArgument>
        </compilerArguments>
    </configuration>
</plugin>
```

